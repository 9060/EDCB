// EpgDataCap3.cpp : DLL アプリケーション用にエクスポートされる関数を定義します。
//

#include "stdafx.h"

#include "EpgDataCap3Main.h"
#include "../../Common/ErrDef.h"
#include "../../Common/BlockLock.h"

class CInstanceManager
{
public:
	static const DWORD INVALID_ID = 0xFFFFFFFF;

	CInstanceManager()
	{
		InitializeCriticalSection(&(this->m_lock));
		this->m_nextID = 1;
	}

	~CInstanceManager()
	{
		DeleteCriticalSection(&(this->m_lock));
	}

	DWORD initialize(BOOL asyncFlag, DWORD *id)
	{
		CBlockLock lock(&(this->m_lock));

		std::shared_ptr<CEpgDataCap3Main> ptr;

		*id = INVALID_ID;

		try {
			ptr = std::make_shared<CEpgDataCap3Main>();
		} catch (std::bad_alloc &) {
			return ERR_FALSE;
		}

		DWORD err = ptr->Initialize(asyncFlag);
		if (err != NO_ERR) {
			return err;
		}

		try {
			*id = this->getNextID();
			this->m_list.insert(std::make_pair(*id,ptr));
		} catch (std::bad_alloc &) {
			*id = INVALID_ID;
			return ERR_FALSE;
		}

		return err;
	}

	DWORD uninitialize(DWORD id)
	{
		CBlockLock lock(&(this->m_lock));

		std::shared_ptr<CEpgDataCap3Main> ptr = this->find(id);
		if (ptr == NULL) {
			return ERR_NOT_INIT;
		}

		DWORD err = ptr->UnInitialize();
		this->m_list.erase(id);

		return err;
	}

	std::shared_ptr<CEpgDataCap3Main> find(DWORD id)
	{
		CBlockLock lock(&(this->m_lock));

		if (this->m_list.count(id) == 0) {
			return NULL;
		}

		return this->m_list.at(id);
	}

protected:
	std::map<DWORD, std::shared_ptr<CEpgDataCap3Main> > m_list;
	DWORD m_nextID;
	CRITICAL_SECTION m_lock;

	DWORD getNextID()
	{
		CBlockLock lock(&(this->m_lock));

		DWORD nextID = INVALID_ID;
		int count = 0;
		do {
			if (this->m_list.count(this->m_nextID) == 0) {
				nextID = this->m_nextID;
			}

			this->m_nextID += 1;
			if ((this->m_nextID == 0)|| (this->m_nextID == INVALID_ID)) {
				this->m_nextID = 1;
			}
			count += 1;

			// 65536 回試してダメだったら断念
			// 1 プロセスから (2^16) 以上のインスタンスを同時に作成することはないはず

		} while ((nextID == INVALID_ID) && (count < (1<<16))); 

		return nextID;
	}
};

CInstanceManager g_instMng;

//DLLの初期化
//戻り値：
// エラーコード
//引数：
// asyncMode		[IN]TRUE:非同期モード、FALSE:同期モード
// id				[OUT]識別ID
DWORD WINAPI InitializeEP(
	BOOL asyncFlag,
	DWORD* id
	)
{
	if (id == NULL) {
		return ERR_INVALID_ARG;
	}

	DWORD err = g_instMng.initialize(asyncFlag, id);

	_OutputDebugString(L"EgpDataCap3.dll [InitializeEP : id=%d]\n", *id);

	return err;
}

//DLLの開放
//戻り値：
// エラーコード
//引数：
// id		[IN]識別ID InitializeEPの戻り値
DWORD WINAPI UnInitializeEP(
	DWORD id
	)
{
	_OutputDebugString(L"EgpDataCap3.dll [UnInitializeEP : id=%d]\n", id);

	DWORD err = g_instMng.uninitialize(id);

	return err;
}

//解析対象のTSパケット１つを読み込ませる
//戻り値：
// エラーコード
// id		[IN]識別ID InitializeEPの戻り値
// data		[IN]TSパケット１つ
// size		[IN]dataのサイズ（188、192あたりになるはず）
DWORD WINAPI AddTSPacketEP(
	DWORD id,
	BYTE* data,
	DWORD size
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->AddTSPacket(data, size);
}

//解析データの現在のストリームＩＤを取得する
//戻り値：
// エラーコード
// id						[IN]識別ID
// originalNetworkID		[OUT]現在のoriginalNetworkID
// transportStreamID		[OUT]現在のtransportStreamID
DWORD WINAPI GetTSIDEP(
	DWORD id,
	WORD* originalNetworkID,
	WORD* transportStreamID
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->GetTSID(originalNetworkID, transportStreamID);
}

//自ストリームのサービス一覧を取得する
//戻り値：
// エラーコード
//引数：
// id						[IN]識別ID
// serviceListSize			[OUT]serviceListの個数
// serviceList				[OUT]サービス情報のリスト（DLL内で自動的にdeleteする。次に取得を行うまで有効）
DWORD WINAPI GetServiceListActualEP(
	DWORD id,
	DWORD* serviceListSize,
	SERVICE_INFO** serviceList
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->GetServiceListActual(serviceListSize, serviceList);
}

//蓄積されたEPG情報のあるサービス一覧を取得する
//SERVICE_EXT_INFOの情報はない場合がある
//戻り値：
// エラーコード
//引数：
// id						[IN]識別ID
// serviceListSize			[OUT]serviceListの個数
// serviceList				[OUT]サービス情報のリスト（DLL内で自動的にdeleteする。次に取得を行うまで有効）
DWORD WINAPI GetServiceListEpgDBEP(
	DWORD id,
	DWORD* serviceListSize,
	SERVICE_INFO** serviceList
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->GetServiceListEpgDB(serviceListSize, serviceList);
}

//指定サービスの全EPG情報を取得する
//戻り値：
// エラーコード
//引数：
// id						[IN]識別ID
// originalNetworkID		[IN]取得対象のoriginalNetworkID
// transportStreamID		[IN]取得対象のtransportStreamID
// serviceID				[IN]取得対象のServiceID
// epgInfoListSize			[OUT]epgInfoListの個数
// epgInfoList				[OUT]EPG情報のリスト（DLL内で自動的にdeleteする。次に取得を行うまで有効）
DWORD WINAPI GetEpgInfoListEP(
	DWORD id,
	WORD originalNetworkID,
	WORD transportStreamID,
	WORD serviceID,
	DWORD* epgInfoListSize,
	EPG_EVENT_INFO** epgInfoList
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->GetEpgInfoList(originalNetworkID, transportStreamID, serviceID, epgInfoListSize, epgInfoList);
}

//指定サービスの現在or次のEPG情報を取得する
//戻り値：
// エラーコード
//引数：
// originalNetworkID		[IN]取得対象のoriginalNetworkID
// transportStreamID		[IN]取得対象のtransportStreamID
// serviceID				[IN]取得対象のServiceID
// nextFlag					[IN]TRUE（次の番組）、FALSE（現在の番組）
// epgInfo					[OUT]EPG情報（DLL内で自動的にdeleteする。次に取得を行うまで有効）
DWORD WINAPI GetEpgInfoEP(
	DWORD id,
	WORD originalNetworkID,
	WORD transportStreamID,
	WORD serviceID,
	BOOL nextFlag,
	EPG_EVENT_INFO** epgInfo
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->GetEpgInfo(originalNetworkID, transportStreamID, serviceID, nextFlag, epgInfo);
}

//指定イベントのEPG情報を取得する
//戻り値：
// エラーコード
//引数：
// id						[IN]識別ID
// originalNetworkID		[IN]取得対象のoriginalNetworkID
// transportStreamID		[IN]取得対象のtransportStreamID
// serviceID				[IN]取得対象のServiceID
// eventID					[IN]取得対象のEventID
// pfOnlyFlag				[IN]p/fからのみ検索するかどうか
// epgInfo					[OUT]EPG情報（DLL内で自動的にdeleteする。次に取得を行うまで有効）
DWORD WINAPI SearchEpgInfoEP(
	DWORD id,
	WORD originalNetworkID,
	WORD transportStreamID,
	WORD serviceID,
	WORD eventID,
	BYTE pfOnlyFlag,
	EPG_EVENT_INFO** epgInfo
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return ERR_NOT_INIT;
	}

	return ptr->SearchEpgInfo(originalNetworkID, transportStreamID, serviceID, eventID, pfOnlyFlag, epgInfo);
}

//EPGデータの蓄積状態をリセットする
//引数：
// id						[IN]識別ID
void WINAPI ClearSectionStatusEP(
	DWORD id
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return;
	}

	ptr->ClearSectionStatus();
}

//EPGデータの蓄積状態を取得する
//戻り値：
// ステータス
//引数：
// id						[IN]識別ID
// l_eitFlag				[IN]L-EITのステータスを取得
EPG_SECTION_STATUS WINAPI GetSectionStatusEP(
	DWORD id,
	BOOL l_eitFlag
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return EpgNoData;
	}

	return ptr->GetSectionStatus(l_eitFlag);
}

//PC時計を元としたストリーム時間との差を取得する
//戻り値：
// 差の秒数
//引数：
// id						[IN]識別ID
int WINAPI GetTimeDelayEP(
	DWORD id
	)
{
	std::shared_ptr<CEpgDataCap3Main> ptr = g_instMng.find(id);
	if (ptr == NULL) {
		return EpgNoData;
	}

	return ptr->GetTimeDelay();
}